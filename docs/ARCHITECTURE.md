# Architecture Documentation

> Technical architecture of the ADK & Chainlit Agent Builder

## Table of Contents

1. [System Overview](#system-overview)
2. [High-Level Architecture](#high-level-architecture)
3. [Component Architecture](#component-architecture)
4. [Code Generation Pipeline](#code-generation-pipeline)
5. [Workflow Types](#workflow-types)
6. [Module Structure](#module-structure)
7. [Data Flow](#data-flow)
8. [Technology Stack](#technology-stack)
9. [Design Patterns](#design-patterns)

---

## System Overview

The ADK & Chainlit Agent Builder is a visual code generator that enables users to design and deploy multi-agent AI workflows through a drag-and-drop interface. The system generates production-ready Python code that combines Google's Agent Development Kit (ADK) with Chainlit's UI framework.

### Key Capabilities

- **Visual Agent Design**: Drag-and-drop interface for creating agents and tools
- **Multi-Workflow Support**: Sequential, Hierarchical, and Collaborative agent patterns
- **Code Generation**: Produces deployment-ready Python code with Docker configuration
- **GCP Integration**: Built-in support for Vertex AI, Memory Bank, and Cloud Run
- **Validation**: Preflight checks ensure configurations are valid before generation

---

## High-Level Architecture

```mermaid
graph TB
    subgraph "Frontend - React Application"
        UI[User Interface]
        WD[Workflow Designer]
        AG[Agent Configurator]
        TL[Tool Builder]
        GCP[GCP Settings]
    end

    subgraph "Validation Layer"
        PF[Preflight Validator]
        TV[Type Validator]
        NV[Name Validator]
    end

    subgraph "Code Generation"
        CG[Code Generator Orchestrator]
        MG[Main.py Generator]
        TG[Tools.py Generator]
        AUX[Auxiliary Generators]
    end

    subgraph "Output"
        PY[Python Files]
        DOC[Docker Config]
        DEPLOY[Deployment Scripts]
    end

    UI --> WD
    WD --> AG
    AG --> TL
    TL --> PF
    GCP --> PF

    PF --> TV
    PF --> NV
    TV --> CG

    CG --> MG
    CG --> TG
    CG --> AUX

    MG --> PY
    TG --> PY
    AUX --> DOC
    AUX --> DEPLOY

    style UI fill:#e1f5ff
    style CG fill:#fff4e1
    style PY fill:#e8f5e9
```

### Architecture Principles

1. **Separation of Concerns**: Each module handles a single responsibility
2. **Validation-First**: All configurations validated before code generation
3. **Modular Generation**: Each output file generated by a specialized module
4. **Type Safety**: TypeScript strict mode with comprehensive type definitions
5. **Testability**: Extensive test coverage with unit and integration tests

---

## Component Architecture

### Frontend Components

```mermaid
graph LR
    subgraph "App.tsx - Main Container"
        STATE[Application State]
        CONFIG[Configuration Manager]
        SYNC[Chainlit Sync]
    end

    subgraph "Workflow Designer"
        CANVAS[Design Canvas]
        TREE[Agent Tree View]
        FLOW[Workflow Selector]
    end

    subgraph "Configuration Panels"
        AGENT[Agent Editor]
        TOOL[Tool Editor]
        PARAM[Parameter Editor]
        GCPUI[GCP Config Panel]
    end

    subgraph "Output & Actions"
        CODE[Code Preview]
        DOWN[Download Manager]
        SYNCER[Sync Manager]
    end

    STATE --> CANVAS
    STATE --> AGENT
    CONFIG --> GCPUI
    CANVAS --> CODE
    CODE --> DOWN
    CODE --> SYNCER

    style STATE fill:#ffecb3
    style CODE fill:#c8e6c9
```

#### Component Responsibilities

| Component | Responsibility | Key Features |
|-----------|---------------|--------------|
| **App.tsx** | Main application container | State management, routing, persistence |
| **WorkflowDesigner** | Visual agent builder | Drag-drop, tree view, workflow selection |
| **AgentPanel** | Agent configuration | LLM selection, prompts, temperature |
| **ToolPanel** | Tool builder | Parameter definition, type mapping |
| **GCPSettings** | Cloud configuration | Project ID, region, Memory Bank toggle |
| **CodePreview** | Generated code display | Syntax highlighting, file tabs |

---

## Code Generation Pipeline

```mermaid
flowchart TD
    START([User Clicks Generate]) --> COLLECT[Collect Configuration]
    COLLECT --> VALIDATE{Preflight Validation}

    VALIDATE -->|Errors| SHOW_ERRORS[Display Validation Errors]
    VALIDATE -->|Success| ORCHESTRATE[Code Generator Orchestrator]

    ORCHESTRATE --> PARALLEL{Parallel Generation}

    PARALLEL --> MAIN[Generate main.py]
    PARALLEL --> TOOLS[Generate tools.py]
    PARALLEL --> REQ[Generate requirements.txt]
    PARALLEL --> README[Generate README.md]
    PARALLEL --> DOCKER[Generate Dockerfile]
    PARALLEL --> GCLOUD[Generate .gcloudignore]

    MAIN --> IMPORTS[Build Imports]
    MAIN --> MEMORY[Configure Memory]
    MAIN --> AGENTS[Create Agent Functions]
    MAIN --> WORKFLOW[Build Workflow Logic]
    MAIN --> HANDLERS[Add Chainlit Handlers]

    TOOLS --> DEDUPE[Deduplicate Tools]
    TOOLS --> MODELS[Generate Pydantic Models]
    TOOLS --> FUNCS[Generate Tool Functions]

    IMPORTS --> MERGE1[Merge]
    MEMORY --> MERGE1
    AGENTS --> MERGE1
    WORKFLOW --> MERGE1
    HANDLERS --> MERGE1

    DEDUPE --> MERGE2[Merge]
    MODELS --> MERGE2
    FUNCS --> MERGE2

    MERGE1 --> ASSEMBLE[Assemble File Map]
    MERGE2 --> ASSEMBLE
    REQ --> ASSEMBLE
    README --> ASSEMBLE
    DOCKER --> ASSEMBLE
    GCLOUD --> ASSEMBLE

    ASSEMBLE --> GCP_CHECK{GCP Config?}
    GCP_CHECK -->|Yes| ADD_GCP[Add cloudbuild.yaml & deploy.sh]
    GCP_CHECK -->|No| COMPLETE
    ADD_GCP --> COMPLETE[Complete Generation]

    COMPLETE --> OUTPUT([Return File Map])
    SHOW_ERRORS --> END([End])
    OUTPUT --> END

    style START fill:#e3f2fd
    style VALIDATE fill:#fff9c4
    style ORCHESTRATE fill:#f3e5f5
    style OUTPUT fill:#c8e6c9
```

### Generation Flow Stages

1. **Collection**: Gather agents, tools, GCP config from UI state
2. **Validation**: Run preflight checks (names, types, models)
3. **Orchestration**: Delegate to specialized generators
4. **Parallel Generation**: Generate independent files concurrently
5. **Assembly**: Combine into final file map
6. **Conditional GCP**: Add deployment files if GCP configured

---

## Workflow Types

### Sequential Workflow

```mermaid
graph LR
    INPUT[User Input] --> A1[Agent 1]
    A1 --> A2[Agent 2]
    A2 --> A3[Agent 3]
    A3 --> OUTPUT[Final Output]

    style INPUT fill:#e3f2fd
    style OUTPUT fill:#c8e6c9
```

**Use Case**: Processing pipeline where each agent refines output
**Example**: Research → Analysis → Summary

**Generated Code Structure**:
```python
workflow = Sequential(
    agents=[agent_1, agent_2, agent_3]
)
```

### Hierarchical Workflow

```mermaid
graph TD
    SUPERVISOR[Supervisor Agent] --> W1[Worker Agent 1]
    SUPERVISOR --> W2[Worker Agent 2]
    SUPERVISOR --> W3[Worker Agent 3]

    W1 --> R1[Result 1]
    W2 --> R2[Result 2]
    W3 --> R3[Result 3]

    R1 --> SUPERVISOR
    R2 --> SUPERVISOR
    R3 --> SUPERVISOR

    SUPERVISOR --> OUTPUT[Coordinated Output]

    style SUPERVISOR fill:#fff9c4
    style OUTPUT fill:#c8e6c9
```

**Use Case**: Delegation pattern with specialized workers
**Example**: Project Manager → {Developer, Designer, QA}

**Generated Code Structure**:
```python
workflow = Hierarchical(
    agents=[supervisor, worker1, worker2, worker3],
    structure={
        supervisor: [worker1, worker2, worker3]
    }
)
```

### Collaborative Workflow

```mermaid
graph TB
    INPUT[User Input] --> TEAM

    subgraph TEAM[Agent Team - Peer Collaboration]
        A1[Agent 1] <--> A2[Agent 2]
        A2 <--> A3[Agent 3]
        A3 <--> A1
    end

    TEAM --> CONSENSUS[Consensus Output]

    style INPUT fill:#e3f2fd
    style CONSENSUS fill:#c8e6c9
```

**Use Case**: Equal peers working together on complex problems
**Example**: Creative brainstorming, multi-perspective analysis

**Generated Code Structure**:
```python
workflow = Collaborative(
    agents=[agent_1, agent_2, agent_3]
)
```

---

## Module Structure

### Directory Layout

```
chainlit-adk-wysiwyg/
├── components/                    # React UI components
│   ├── common/                   # Reusable components
│   │   ├── Button.tsx
│   │   ├── Card.tsx
│   │   └── Input.tsx
│   ├── AgentPanel.tsx            # Agent configuration
│   ├── GCPSettings.tsx           # Cloud settings
│   ├── ToolPanel.tsx             # Tool builder
│   └── WorkflowDesigner.tsx      # Visual designer
├── services/                      # Business logic
│   ├── generators/               # Code generation modules
│   │   ├── utils.ts              # String formatting utilities
│   │   ├── toolsGenerator.ts    # tools.py generator
│   │   ├── mainGenerator.ts     # main.py generator
│   │   └── auxiliaryGenerators.ts # Supporting files
│   ├── codeGenerator.ts          # Main orchestrator
│   ├── preflight.ts              # Validation service
│   ├── chainlitSync.ts           # Sync to chainlit_app/
│   └── persistence.ts            # LocalStorage manager
├── types/                         # TypeScript definitions
│   └── index.ts                  # All type definitions
├── test/                          # Test suites
│   ├── integration.test.ts       # Full workflow tests
│   ├── codeGenerator.test.ts    # Generator unit tests
│   ├── preflight.test.ts         # Validation tests
│   └── components.test.tsx       # UI component tests
├── docs/                          # Documentation
│   ├── ARCHITECTURE.md           # This file
│   ├── DEPLOYMENT_GUIDE.md       # Deployment guide
│   ├── API_DOCUMENTATION.md      # API reference
│   └── WORKFLOW_GUIDE.md         # Workflow patterns
├── App.tsx                        # Main React component
└── main.tsx                       # Entry point
```

### Generator Module Architecture

```mermaid
classDiagram
    class CodeGenerator {
        +generateCode(agents, gcpConfig, workflowType)
        -collectTools()
        -assembleFiles()
    }

    class MainGenerator {
        +generateMainPy()
        -generateImports()
        -generateMemoryConfig()
        -generateAgentFunctions()
        -generateWorkflowInstantiation()
        -generateChainlitHandlers()
    }

    class ToolsGenerator {
        +generateToolsPy()
        -generateWeatherTool()
        -generateGenericTool()
        -deduplicateTools()
    }

    class AuxiliaryGenerators {
        +generateRequirementsTxt()
        +generateReadme()
        +generateDockerfile()
        +generateCloudBuildYaml()
        +generateDeploySh()
        +generateGcloudIgnore()
    }

    class Utils {
        +toSnakeCase()
        +toPascalCase()
        +toKebabCase()
        +getPythonType()
    }

    CodeGenerator --> MainGenerator : uses
    CodeGenerator --> ToolsGenerator : uses
    CodeGenerator --> AuxiliaryGenerators : uses
    MainGenerator --> Utils : uses
    ToolsGenerator --> Utils : uses
```

---

## Data Flow

### User Configuration to Generated Code

```mermaid
sequenceDiagram
    participant User
    participant UI as Workflow Designer
    participant State as App State
    participant Validator as Preflight
    participant Generator as Code Generator
    participant Output as File System

    User->>UI: Design Workflow
    UI->>State: Update Agent Config
    User->>UI: Configure Tools
    UI->>State: Update Tool Config
    User->>UI: Click Generate
    UI->>Validator: Validate Configuration

    alt Validation Failed
        Validator-->>UI: Return Errors
        UI-->>User: Display Errors
    else Validation Success
        Validator->>Generator: Pass Valid Config
        Generator->>Generator: Generate main.py
        Generator->>Generator: Generate tools.py
        Generator->>Generator: Generate supporting files
        Generator-->>UI: Return File Map
        UI->>Output: Create ZIP/Sync Files
        Output-->>User: Download/Sync Complete
    end
```

### State Management Flow

```mermaid
stateDiagram-v2
    [*] --> Empty: App Loads
    Empty --> ConfiguringAgents: Add Agent
    ConfiguringAgents --> ConfiguringTools: Add Tools
    ConfiguringTools --> ConfiguringGCP: Configure GCP
    ConfiguringGCP --> ReadyToGenerate: Configuration Complete

    ReadyToGenerate --> Validating: Click Generate
    Validating --> ValidationFailed: Errors Found
    Validating --> Generating: Validation Passed

    ValidationFailed --> ConfiguringAgents: Fix Issues
    ValidationFailed --> ConfiguringTools: Fix Issues

    Generating --> CodeReady: Generation Complete
    CodeReady --> Downloading: Download ZIP
    CodeReady --> Syncing: Sync to Chainlit

    Downloading --> [*]: Complete
    Syncing --> [*]: Complete

    note right of Validating
        - Check agent names
        - Validate tool parameters
        - Verify LLM models
        - Check Python identifiers
    end note

    note right of Generating
        - Generate main.py
        - Generate tools.py
        - Generate Dockerfile
        - Generate deployment scripts
    end note
```

---

## Technology Stack

### Frontend

```mermaid
graph TB
    subgraph "UI Layer"
        REACT[React 18]
        TS[TypeScript 5]
        VITE[Vite]
    end

    subgraph "State Management"
        HOOKS[React Hooks]
        CONTEXT[Context API]
        LOCAL[LocalStorage]
    end

    subgraph "Styling"
        CSS[CSS Modules]
        TAILWIND[Tailwind CSS]
    end

    subgraph "Testing"
        VITEST[Vitest]
        RTL[React Testing Library]
    end

    REACT --> HOOKS
    TS --> REACT
    VITE --> REACT
    HOOKS --> LOCAL
    REACT --> CSS
    CSS --> TAILWIND
    VITEST --> RTL

    style REACT fill:#61dafb,color:#000
    style TS fill:#3178c6,color:#fff
```

### Backend (Generated Code)

```mermaid
graph TB
    subgraph "Framework"
        CL[Chainlit]
        ADK[Google ADK]
    end

    subgraph "LLM Providers"
        VERTEX[Vertex AI - Gemini]
        OPENAI[OpenAI - GPT]
    end

    subgraph "Memory"
        MB[Memory Bank - GCP]
        LOCAL_MEM[Local Memory]
    end

    subgraph "Deployment"
        DOCKER[Docker]
        CLOUD_RUN[Cloud Run]
        CLOUD_BUILD[Cloud Build]
    end

    CL --> ADK
    ADK --> VERTEX
    ADK --> OPENAI
    ADK --> MB
    ADK --> LOCAL_MEM
    CL --> DOCKER
    DOCKER --> CLOUD_BUILD
    CLOUD_BUILD --> CLOUD_RUN

    style CL fill:#00bcd4,color:#000
    style ADK fill:#4285f4,color:#fff
```

### Technology Choices

| Component | Technology | Rationale |
|-----------|-----------|-----------|
| **UI Framework** | React 18 | Component composition, hooks, performance |
| **Language** | TypeScript 5 | Type safety, better DX, catch errors early |
| **Build Tool** | Vite | Fast HMR, modern tooling, optimized builds |
| **Testing** | Vitest | Fast, Vite-native, compatible with Jest |
| **Backend Framework** | Chainlit | Built for conversational AI, easy deployment |
| **Agent Framework** | Google ADK | Multi-agent support, tool integration |
| **Deployment** | Docker + Cloud Run | Containerized, scalable, serverless |

---

## Design Patterns

### 1. Generator Pattern

Each file type has a dedicated generator module:

```typescript
// Generator interface pattern
export const generateMainPy = (
  agents: Agent[],
  gcpConfig: GCPConfig,
  workflowType: WorkflowType
): string => {
  // Generate complete main.py content
  const imports = generateImports(agents, workflowType);
  const memory = generateMemoryConfig(gcpConfig);
  const agentFunctions = generateAgentCreationFunctions(agents);
  const workflow = generateWorkflowInstantiation(agents, workflowType);

  return assembleFile([imports, memory, agentFunctions, workflow]);
};
```

**Benefits:**
- Single Responsibility Principle
- Easy to test individual generators
- Parallel generation possible
- Clear separation of concerns

### 2. Strategy Pattern

Different workflow types use different generation strategies:

```typescript
function generateWorkflowInstantiation(
  agents: Agent[],
  workflowType: WorkflowType
): string {
  switch (workflowType) {
    case 'Hierarchical':
      return generateHierarchicalWorkflow(agents);
    case 'Collaborative':
      return generateCollaborativeWorkflow(agents);
    case 'Sequential':
    default:
      return generateSequentialWorkflow(agents);
  }
}
```

**Benefits:**
- Easy to add new workflow types
- Clear workflow-specific logic
- Testable in isolation

### 3. Builder Pattern

Complex agent configurations built incrementally:

```typescript
const agent = {
  id: generateId(),
  name: 'Customer Service Agent',
  llmModel: 'gemini-1.5-flash',
  temperature: 0.7,
  tools: [],
  system_prompt: '',
  welcome_message: '',
};

// User adds tools incrementally
agent.tools.push(newTool);
```

**Benefits:**
- Flexible configuration
- Validates at each step
- Clear state progression

### 4. Observer Pattern

State changes propagate to UI components:

```typescript
// App.tsx manages state
const [agents, setAgents] = useState<Agent[]>([]);

// Components observe state
<WorkflowDesigner
  agents={agents}
  onAgentsChange={setAgents}
/>
```

**Benefits:**
- Reactive UI updates
- Decoupled components
- Easy to debug state flow

### 5. Validation Chain Pattern

Multiple validators run in sequence:

```typescript
export function runPreflightValidation({ agents }: PreflightInput) {
  const issues: ValidationIssue[] = [];

  // Chain of validators
  validateAgentCount(agents, issues);
  validateAgentNames(agents, issues);
  validateLLMModels(agents, issues);
  validateTools(agents, issues);
  validateParameters(agents, issues);

  return buildResult(issues);
}
```

**Benefits:**
- Comprehensive validation
- Clear error messages
- Easy to add new validators

---

## Performance Considerations

### Code Generation Performance

```mermaid
pie title "Code Generation Time Distribution"
    "Tool Deduplication" : 15
    "Main.py Generation" : 35
    "Tools.py Generation" : 25
    "Auxiliary Files" : 15
    "File Assembly" : 10
```

**Optimizations:**
- Tool deduplication uses `Map` for O(1) lookup
- Generators run conceptually in parallel (synchronous but independent)
- Template strings pre-compiled at module load
- Minimal string manipulation with template literals

### UI Performance

- **LocalStorage caching** prevents config loss
- **Debounced validation** reduces unnecessary checks
- **Lazy loading** for code preview syntax highlighting
- **Memoized components** prevent unnecessary re-renders

---

## Security Architecture

```mermaid
graph TB
    USER[User Input] --> SANITIZE[Input Sanitization]
    SANITIZE --> VALIDATE[Validation Layer]
    VALIDATE --> GENERATE[Code Generation]

    GENERATE --> ESCAPE[Escape User Strings]
    ESCAPE --> INJECT_CHECK[Injection Prevention]
    INJECT_CHECK --> OUTPUT[Generated Code]

    subgraph "Security Checks"
        SANITIZE
        VALIDATE
        ESCAPE
        INJECT_CHECK
    end

    style SANITIZE fill:#ffcccc
    style ESCAPE fill:#ffcccc
```

**Security Measures:**
- Input sanitization for agent/tool names
- Python keyword validation
- Template literal escaping for user strings
- No eval() or exec() in generated code
- Service account key validation
- Secret management recommendations

---

## Future Architecture Considerations

### Planned Enhancements

1. **Plugin System**
   - Custom tool templates
   - Community-contributed workflows
   - Third-party LLM providers

2. **Real-time Collaboration**
   - WebSocket-based co-editing
   - Shared workflow templates
   - Team workspaces

3. **Enhanced Deployment**
   - AWS/Azure support
   - Kubernetes manifests
   - Terraform configurations

4. **Monitoring Integration**
   - Built-in observability
   - Performance metrics
   - Cost tracking

---

## Appendix

### Key Type Definitions

```typescript
interface Agent {
  id: string;
  name: string;
  system_prompt: string;
  welcome_message: string;
  input_placeholder: string;
  tools: Tool[];
  llmModel: string;
  temperature: number;
  parentId: string | null;
}

interface Tool {
  id: string;
  name: string;
  description: string;
  parameters: Parameter[];
}

interface Parameter {
  id: string;
  name: string;
  type: 'string' | 'number' | 'boolean';
  description: string;
  required: boolean;
}

interface GCPConfig {
  projectId: string;
  serviceName: string;
  region: string;
  serviceAccountKeyJson: string;
  serviceAccountKeyName: string;
  useMemoryBank: boolean;
}

type WorkflowType = 'Sequential' | 'Hierarchical' | 'Collaborative';
```

### References

- [Google ADK Documentation](https://github.com/google/adk)
- [Chainlit Documentation](https://docs.chainlit.io)
- [React Architecture Patterns](https://reactpatterns.com)
- [TypeScript Best Practices](https://typescript-eslint.io)

---

**Last Updated**: 2025-10-22
**Version**: 1.0.0
